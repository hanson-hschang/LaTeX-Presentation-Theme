%%----------------------------------------------------------------------------------------
%%   BEAMER THEME: Presentation
%%----------------------------------------------------------------------------------------

\mode<all>{
%%----------------------------------------------------------------------------------------
%%   PACKAGE LOADING
%%----------------------------------------------------------------------------------------

%% Load the xparse package for advanced command definitions
\RequirePackage{xparse}

%% Load the ifthen package for conditional statements
\RequirePackage{ifthen}

%% Load the encoding package for UTF-8 support
%% (This should be loaded before any other packages that use characters, e.g. fontenc, biblatex)
\RequirePackage[utf8]{inputenc}

%% Load the font encoding package for better font support
\RequirePackage[T1]{fontenc}

%% Load the textcomp package for additional text symbols
\RequirePackage{textcomp}

%% Load the bibliography package
\makeatletter
\@ifundefined{opt@biblatex.sty}{
  \RequirePackage[backend=biber, style=alphabetic, citestyle=authoryear]{biblatex}
}{
  \RequirePackage[backend=biber]{biblatex}
}
\makeatother
%% Change parentheses to square brackets for parenthetical citations like \autocite
\renewcommand*{\mkbibparens}[1]{\bibopenbracket#1\bibclosebracket}
\AtBeginBibliography{\small}

%% Load the appendixnumberbeamer packages for appendix slide numbering
\RequirePackage{appendixnumberbeamer}
  \pdfstringdefDisableCommands{%
  \def\translate#1{#1}%
}

%% Load the xcolor package for color support with the
%% dvipsnames option providing a wide range of predefined colors
\RequirePackage[dvipsnames]{xcolor}

%% Load math packages for mathematical typesetting
\RequirePackage{amsmath, amsfonts, amsthm, amssymb, mathtools, mathrsfs, mathdots}

%% Load the nicefrac package for typesetting fractions
\RequirePackage{nicefrac}

%% Load the cancel package for striking out text in math mode
\RequirePackage{cancel}

%% Load the Mathematical Nature Symbols package for additional math symbols
\RequirePackage{MnSymbol}

%% Load the Double-Struck Font package for double-struck symbols \mathds{...}
\RequirePackage{dsfont}

%% Load the Upgreek package for upright Greek letters
\RequirePackage{upgreek}

%% Load the systeme package for typesetting systems of linear (and non-linear) equations.
\RequirePackage{systeme}

%% Load the siunitx package for SI units and numbers
%% Use the locale option to set the number formatting according to the specified location.
\RequirePackage[locale=US]{siunitx}

%% Load the graphicx package for including graphics
\RequirePackage{graphicx}

%% Load the pifont package for special symbols
%% https://dl.icdst.org/pdfs/files3/1900293ae8829c4c53fe55f2c9f0077c.pdf
\RequirePackage{pifont}

%% Load the TikZ package for creating graphics
\RequirePackage{tikz}
\usetikzlibrary{intersections, angles, quotes, positioning}
\usetikzlibrary{arrows.meta}

%% Load the pgfplots package for creating plots
\RequirePackage{pgfplots}
\pgfplotsset{compat=1.13}

%% Load the multirow and multicol packages for advanced row and column formatting
\RequirePackage{multirow}
\RequirePackage{multicol}

%% Load the quotes package for better quotation handling
\RequirePackage{csquotes} 
\renewcommand{\mkbegdispquote}[2]{\itshape}

%% Load the hyperref package for hyperlinks
%% Beamer is designed to automatically load and configure the hyperref package in a way 
%% that is compatible with its themes. Never load hyperref manually in a Beamer document.
%% If you need to pass options to hyperref, do so by using the \hypersetup command after
%% loading the beamer class.
% \hypersetup{
%   colorlinks=true,
%   urlcolor=blue,      % Color for external links
%   linkcolor=blue,     % Color for internal links (e.g., table of contents)
%   citecolor=blue      % Color for citations
% }

%% Load the soul package for text highlighting
% \RequirePackage{soulutf8} %% Use this for UTF-8 support with highlighting
\RequirePackage{soul}
\newcommand{\spaceout}{\so}

%% Load the fancyvrb package for fancy verbatim text handling
\RequirePackage{fancyvrb}

%% Load the enumitem package for advanced list formatting
\RequirePackage{enumitem}

%% Load the minted package for syntax highlighting in code listings
\RequirePackage{minted}
%% Define 'latexcode' environment as a wrapper for 'minted' with LaTeX syntax highlighting
\newminted{latex}{
  breaklines, 
  breakanywhere, 
  fontsize=\footnotesize, 
  linenos=true, 
  numbersep=5pt, 
  frame=lines, 
  framesep=2mm, 
  tabsize=2, 
  autogobble=true
}

%% Load the booktabs package for better table formatting
\RequirePackage{booktabs}

%% Load the array dashed line package for advanced array and tabular features
\RequirePackage{arydshln}

%% Load the caption and subcaption packages for figure and table captions
\RequirePackage{caption}
\RequirePackage{subcaption}
\captionsetup{labelfont = bf, labelsep = period, font = {footnotesize}}

%% Load the multimedia package for embedding movie and sound files
\RequirePackage{multimedia}

%% Load the pbox package for paragraph boxes
\RequirePackage{pbox}

%% Load the algorithm and algpseudocode packages for algorithm formatting
\RequirePackage{algorithm}
\RequirePackage{algpseudocode}

%% Load the float package for controlling float placement
\RequirePackage{float}

%% Load the nameref package for referencing names
\RequirePackage{nameref}

%%----------------------------------------------------------------------------------------
%%   CONTENT DIRECTORY MANAGEMENT
%%----------------------------------------------------------------------------------------

%% Set the default content directory
\newcommand{\document@directory}{.} 

%% Update the content directory
\NewDocumentCommand{\setdirectory}{O{.}}{%
  \renewcommand{\document@directory}{#1}%
}

%% Update the content directory for appendices
\NewDocumentCommand{\setappendix}{O{.}}{%
  \renewcommand{\document@directory}{#1}%
  \appendix%
}

%% Load the content .tex file from the specified directory
\newcommand{\addcontent}[1]{\input{\document@directory/#1}}

%% Remove frames from the navigation dots with \miniframesoff and \miniframeson
%% https://tex.stackexchange.com/questions/752486/how-to-exclude-section-toc-slides-from-navigation-dots-in-beamer
\makeatletter
\let\beamer@writeslidentry@miniframeson=\beamer@writeslidentry%
\def\beamer@writeslidentry@miniframesoff{%
  \expandafter\beamer@ifempty\expandafter{\beamer@framestartpage}{}% does not happen normally
  {%else
    % removed \addtocontents commands
    \clearpage\beamer@notesactions%
  }
}
\newcommand*{\miniframeson}{\let\beamer@writeslidentry=\beamer@writeslidentry@miniframeson}
\newcommand*{\miniframesoff}{\let\beamer@writeslidentry=\beamer@writeslidentry@miniframesoff}
\makeatother

} %% end \mode<all>

%%----------------------------------------------------------------------------------------
%%   BEAMER PRESENTATION MODE
%%----------------------------------------------------------------------------------------
\mode<presentation>{

  \ProvidesPackage{beamerthemePresentation}

  %% Load the default beamer theme as the base theme
  \usetheme{default}

  %% Load a font theme
  \usepackage[space]{erewhon}

  %% Load an inner theme
  \useinnertheme{rounded}
  \useinnertheme{rectangles}

  % Define custom colors
  \definecolor{default-color}{HTML}{272727}
  \definecolor{background-color}{HTML}{FAFAF1}
  \definecolor{accent-color}{HTML}{13294B}
  \definecolor{highlight-color}{HTML}{FF5F05}
  \definecolor{contrast-color}{HTML}{FFFFFF}

  % Define transparency variable
  \def\transparency{50}

  % Set beamer colors
  \setbeamercolor{item projected}{
    fg=contrast-color, 
    bg=accent-color,
  }
  \setbeamercolor{section in toc}{
    fg=accent-color,
  }
  \setbeamercolor{background canvas}{
    bg=background-color,
  }
  \setbeamercolor{frametitle}{
    fg=contrast-color,
    bg=accent-color, 
  }
  \setbeamercolor{section in head/foot}{
    fg=accent-color, 
    bg=background-color,
  }
  \setbeamercolor{author in head/foot}{
    fg=contrast-color, 
    bg=accent-color,
  }
  \setbeamercolor{title in head/foot}{
    fg=contrast-color, 
    bg=accent-color,
  }
  \setbeamercolor{date in head/foot}{
    fg=contrast-color, 
    bg=accent-color,
  }
  \setbeamercolor{itemize item}{
    fg=accent-color,
  }

  % Set title page colors
  \setbeamercolor{title}{fg=accent-color}
  \setbeamercolor{subtitle}{fg=accent-color!\transparency}
  \setbeamercolor{author}{fg=accent-color}
  \setbeamercolor{institute}{fg=accent-color!\transparency}
  \setbeamercolor{date}{fg=accent-color!\transparency}

  % Customize title page spacing
  \setbeamertemplate{title page}{
    \vspace{0.15\paperheight}
    \begin{centering}
      {\usebeamerfont{title}\usebeamercolor[fg]{title}\inserttitle\par}
      \vspace{0.5em}
      {\usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par}
      \vspace{2em}
      {\usebeamerfont{author}\usebeamercolor[fg]{author}\insertauthor\par}
      \vspace{1em}
      {\usebeamerfont{institute}\usebeamercolor[fg]{institute}\insertinstitute\par}
      \vspace{2em}
      {\usebeamerfont{date}\usebeamercolor[fg]{date}\insertdate\par}
    \end{centering}
  }

  % Set header with section navigation
  \setbeamertemplate{headline}{
    \begin{beamercolorbox}{section in head/foot}  
      \vspace*{1pt}  
      \insertnavigation{\paperwidth}
      \vspace*{1pt}
    \end{beamercolorbox}
  }

  % Customize frametitle to always show subtitle space
  \setbeamertemplate{frametitle}{
    \nointerlineskip
    \begin{beamercolorbox}[wd=\paperwidth, ht=2.5ex, dp=2.5ex, leftskip=1ex]{frametitle}
      \vtop{
        \usebeamerfont*{frametitle}\insertframetitle\par
        \usebeamerfont*{framesubtitle}\usebeamercolor[fg]{framesubtitle}\insertframesubtitle\par
      }%
    \end{beamercolorbox}
  }

  % Insert logo at the end of the frametitle
  \addtobeamertemplate{frametitle}{}{
    \vspace*{-4.2ex}
    \hfill\insertlogo
  }

  \newif\ifframenumber
  \framenumbertrue

  \newenvironment{noframenumber}
  {\framenumberfalse}  % Execute when entering environment
  {\framenumbertrue}   % Execute when leaving environment

  \setbeamertemplate{footline}{
    % Switch the typesetting from vertical mode to horizontal mode
    \leavevmode%
    \hbox{%
      \begin{beamercolorbox}[wd=.3\paperwidth,ht=2.25ex,dp=1ex,left]{author in head/foot}%
        \hspace{1em}\usebeamerfont{author in head/foot}\insertshortauthor\ (\insertshortinstitute)
      \end{beamercolorbox}%
      \begin{beamercolorbox}[wd=.6\paperwidth,ht=2.25ex,dp=1ex,left]{title in head/foot}%
        \usebeamerfont{title in head/foot}\insertshorttitle
      \end{beamercolorbox}%
      \begin{beamercolorbox}[wd=.1\paperwidth,ht=2.25ex,dp=1ex,right]{date in head/foot}%
        \ifframenumber
         \hspace*{1ex}\usebeamerfont{date in head/foot}\insertframenumber{} / \inserttotalframenumber\hspace*{1ex}
        \fi
      \end{beamercolorbox}
    }
  }

  %% Uncomment the next line to remove the control symbol
  % \beamertemplatenavigationsymbolsempty

  %% Add high lighted TOC before each section
  \AtBeginSection[]{
    \miniframesoff
    \begin{noframenumber}
      \begin{frame}[noframenumbering]
        \frametitle{Table of Contents}
        \tableofcontents[currentsection]
      \end{frame}
    \end{noframenumber}
    \miniframeson
  }

  \setbeamersize{text margin left=1em,text margin right=1em}

} %% end \mode<presentation>

%%----------------------------------------------------------------------------------------
%%   BEAMER HANDOUT MODE
%%----------------------------------------------------------------------------------------
\mode<handout>{

%% Load the pgfpages package for creating handouts with multiple slides per page
\RequirePackage{pgfpages}
% \setbeameroption{show notes on second screen}
% \setbeamertemplate{note page}{\insertnote}

%% Set the layout for the handout, e.g., 2 slides per page with notes
\pgfpagesuselayout{2 on 1 with notes}[a4paper, border shrink=5mm]

%% Set the template for how notes are displayed on the page
\setbeamertemplate{note page}[plain]

} %% end \mode<handout>
